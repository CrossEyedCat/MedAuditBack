# Миграции базы данных

## Создание миграций

Для создания миграций используется Alembic. Все модели автоматически обнаруживаются через импорт в `alembic/env.py`.

### Создание новой миграции

```bash
# Автоматическое создание миграции на основе изменений моделей
alembic revision --autogenerate -m "описание изменений"

# Создание пустой миграции (для ручных изменений)
alembic revision -m "описание изменений"
```

### Применение миграций

```bash
# Применить все миграции до последней версии
alembic upgrade head

# Применить конкретную миграцию
alembic upgrade <revision>

# Откатить последнюю миграцию
alembic downgrade -1

# Откатить все миграции
alembic downgrade base
```

### Просмотр статуса миграций

```bash
# Текущая версия БД
alembic current

# История миграций
alembic history

# Показать SQL для миграции (без применения)
alembic upgrade head --sql
```

## Структура миграций

Миграции хранятся в `alembic/versions/` и имеют формат:
```
<revision>_<description>.py
```

Пример: `a1b2c3d4e5f6_create_users_table.py`

## Первоначальная миграция

Для создания первоначальной миграции со всеми моделями:

```bash
# 1. Убедитесь, что все модели импортированы в alembic/env.py
# 2. Создайте миграцию
alembic revision --autogenerate -m "Initial migration - create all tables"

# 3. Проверьте созданный файл миграции
# 4. Примените миграцию
alembic upgrade head
```

## Модели в системе

Система включает следующие модели:

1. **users** - Пользователи системы
2. **documents** - Загруженные документы
3. **audit_reports** - Отчеты об аудите
4. **violations** - Выявленные нарушения
5. **analysis_summaries** - Сводки анализа

## Важные замечания

1. **Всегда проверяйте** созданные миграции перед применением
2. **Не редактируйте** существующие миграции после применения
3. **Создавайте новую миграцию** для отката изменений
4. **Тестируйте миграции** на тестовой БД перед применением на production

## Пример создания миграции для всех моделей

```bash
# 1. Убедитесь, что БД создана и доступна
# 2. Создайте миграцию
alembic revision --autogenerate -m "Create all tables: users, documents, audit_reports, violations, analysis_summaries"

# 3. Проверьте файл миграции в alembic/versions/
# 4. При необходимости отредактируйте миграцию
# 5. Примените миграцию
alembic upgrade head
```

## Откат миграций

```bash
# Откатить последнюю миграцию
alembic downgrade -1

# Откатить до конкретной версии
alembic downgrade <revision>

# Откатить все миграции (осторожно!)
alembic downgrade base
```

## Troubleshooting

### Проблема: Миграция не создается

1. Проверьте, что все модели импортированы в `alembic/env.py`
2. Убедитесь, что подключение к БД работает
3. Проверьте, что нет синтаксических ошибок в моделях

### Проблема: Конфликт миграций

1. Проверьте текущую версию: `alembic current`
2. Синхронизируйте версию в БД с файлами миграций
3. При необходимости создайте новую миграцию вручную

### Проблема: Ошибки при применении миграции

1. Проверьте логи ошибок
2. Убедитесь, что БД доступна
3. Проверьте права доступа к БД
4. При необходимости откатите миграцию и исправьте ошибки





